#!/bin/bash

#SBATCH --job-name=OF_$FOLD_NAME
#SBATCH -D $OPENFOLD_SCRIPTS
#SBATCH -o $OUT_DIR/slurm-%A_%a.out
#SBATCH --account=$ACCOUNT
#SBATCH --time=4:00:00
#SBATCH --cpus-per-task=8
#SBATCH --mem=40G

set -ex

echo "activating env"
mamba activate openfold_env

export OF_SCRIPTS=$OPENFOLD_SCRIPTS
export IN=$IN_DIR
export OUT=$OUT_DIR
export DB_DIR=$OPENFOLD_DB
export NAME=$FOLD_NAME

align_start=`date +%s`
echo "running colabfold on $IN"
cd ${OF_SCRIPTS}/..
python3 ${OF_SCRIPTS}/precompute_alignments_mmseqs.py \
--threads 72 \
--hhsearch_binary_path hhsearch \
--pdb70 ${DB_DIR}/pdb100 \
--env_db colabfold_envdb_202108_db \
${IN}/${NAME}.fa \
${DB_DIR} \
uniref30_2302_db \
${OUT} \
mmseqs

python ${OF_SCRIPTS}/precompute_alignments.py \
${IN} \
${OUT} \
--uniprot_database_path ${DB_DIR}/uniprot/uniprot.fasta \
--jackhmmer_binary_path jackhmmer \
--cpus_per_task 72

align_end=`date +%s`
align_time=$(((align_end-align_start)/60))

fold_start=`date +%s`
for model in 1 2 3
do
  echo "folding using model $model"
  python3 run_pretrained_openfold.py \
  ${IN} \
  ${DB_DIR}/pdb_mmcif/mmcif_files \
  --use_precomputed_alignments ${OUT} \
  --config_preset "model_${model}_multimer_v3" \
  --model_device "cuda:0" \
  --output_dir ${OUT} \
  --save_outputs

  #/home/def-marechal/programs/Marechal_pipelines/environment/test.openfold.multi/openfold.multi/DTX1_1_DTX2_1/predictions/DTX1_1-DTX2_1_model_1_multimer_v3_output_dict.pkl
  python ${OF_SCRIPTS}/generate_pae_plddt_plot.py \
  --input_pkl ${OUT}/predictions/${NAME}_model_${model}_multimer_v3_output_dict.pkl \
  --output_dir ${OUT} \
  --basename "model_${model}"

done

convert ${OUT}/*_pLDDT.png +append ${OUT}/${NAME}_all_PLDDT.png
convert ${OUT}/*_PAE.png  +append ${OUT}/${NAME}_all_PAE.png

python ${OF_SCRIPTS}/generate_coverage_plot.py \
--input_pkl ${OUT}/${NAME}_model_${model}_multimer_v3_feature_dict.pickle \
--output_dir ${OUT} \
--basename "model_${model}"

fold_end=`date +%s`
fold_time=$(((fold_end-fold_start)/60))

echo "running AF2multimer-analysis on $outdir"
mkdir -p $outdir/unrelaxed
mv $outdir/*unrelaxed_* $outdir/unrelaxed/
python $script_path/AF2multimer-analysis/colabfold_analysis.py $outdir

echo "zipping results"
cd $outdir/../
zip -r $job_name.zip $job_name/*



# output: exp_name\talign time\tfold time
# in min
echo -e "${NAME}\t$align_time\t$fold_time" >> /tank/jflucier/run_stats.tsv



